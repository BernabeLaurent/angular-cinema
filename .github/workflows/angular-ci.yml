name: Angular CI & Deploy

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. üîÑ R√©cup√©rer le code source
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. üü¢ Installer Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'

      # 3. üì¶ Installer les d√©pendances
      - name: Install dependencies
        run: npm install

      # 4. üß™ Lancer les tests Angular
      - name: Run tests
        run: npm run test -- --watch=false --browsers=ChromeHeadless
        continue-on-error: true  # on continue en cas d'erreur de test

      # √âtape de d√©bogage pour v√©rifier que le secret est bien charg√©
      - name: Check GitHub Secret GITHUBACTIONS
        run: |
          echo "Checking if GITHUBACTIONS secret is loaded:"
          echo "${{ secrets.GITHUBACTIONS }}" # Cela ne doit pas afficher la cl√© en entier pour des raisons de s√©curit√©, mais v√©rifie que le secret est charg√©


      # 5. üõ†Ô∏è Pr√©parer SSH pour le d√©ploiement
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITHUBACTIONS }}" > ~/.ssh/github-actions
          chmod 600 ~/.ssh/github-actions
          ssh-keyscan -H 159.89.20.85 >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/github-actions root@159.89.20.85 "echo ‚úÖ Connexion SSH r√©ussie"

      # √âtapes de d√©bogage pour v√©rifier si la cl√© SSH a bien √©t√© stock√©e et a les bonnes permissions
      - name: Debug SSH Key
        run: |
          echo "Listing files in ~/.ssh"
          ls -l ~/.ssh
          echo "Permissions of the SSH key:"
          ls -l ~/.ssh/github-actions
          echo "SSH key content (first 5 lines):"
          head -n 5 ~/.ssh/github-actions

      # 6. üöÄ D√©ployer sur le droplet
      - name: Deploy to Angular Droplet
        run: |
          ssh -i ~/.ssh/github-actions root@159.89.20.85 << 'EOF'
            cd /var/www/angular-cinema
            git pull origin main
            docker compose down
            docker compose build
            docker compose up -d
          EOF
